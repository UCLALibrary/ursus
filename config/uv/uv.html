<!--
    This is what the embed iframe src links to. It doesn't need to communicate with the parent page, only fill the available space and look for #? parameters
-->

<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="uv.css">
    <script type="text/javascript" src="lib/offline.js"></script>
    <script type="text/javascript" src="helpers.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;

        }

        .moreInfo {
          display: inline-block !important;
        }

        .title > span {
            display: none;
         }

    </style>
    <script type="text/javascript">
    window.addEventListener('uvLoaded', function(e) {
            urlDataProvider = new UV.URLDataProvider(true);
            var formattedLocales;
            var locales = urlDataProvider.get('locales', '');
            if (locales) {
                var names = locales.split(',');
                formattedLocales = [];
                for (var i in names) {
                    var nameparts = String(names[i]).split(':');
                    formattedLocales[i] = {name: nameparts[0], label: nameparts[1]};
                }

            } else {
                formattedLocales = [
                    {
                        name: 'en-GB'
                    }
                ]
            }
            uv = createUV('#uv', {
                root: '.',
                iiifResourceUri: urlDataProvider.get('manifest'),
                configUri: 'uv-config.json',
                collectionIndex: Number(urlDataProvider.get('c', 0)),
                manifestIndex: Number(urlDataProvider.get('m', 0)),
                sequenceIndex: Number(urlDataProvider.get('s', 0)),
                canvasIndex: Number(urlDataProvider.get('cv', 0)),
                rangeId: urlDataProvider.get('rid', 0),
                rotation: Number(urlDataProvider.get('r', 0)),
                xywh: urlDataProvider.get('xywh', ''),
                embedded: true,
                locales: formattedLocales
            }, urlDataProvider);
        }, false);
    </script>
</head>
<body>

    <div class="media-wrapper">
        <video src="https://wowza.library.ucla.edu/iiif_av_public/definst/mp4:synanon/pairtree_root/21/19/8=/zz/00/2h/ds/j2/21198=zz002hdsj2/ark%2B=21198=zz002hdsj2.mp4/manifest.mpd" width="320" height="240"
            class="mejs__player"
            poster="https://static.library.ucla.edu/video_icon.svg"
             data-mejsoptions='{"alwaysShowControls": "true"}'>
        </video>
    </div>

<script>
    $(function() {
        var $UV = $('#uv');
        function resize() {
            var windowWidth = window.innerWidth;
            var windowHeight = window.innerHeight;
            $UV.width(windowWidth);
            $UV.height(windowHeight);
        }
        $(window).on('resize' ,function() {
            resize();
        });

        resize();
    });

</script>

<script type="text/javascript" src="uv.js"></script>

<script>
    function getQueryStringValue (key) {
return decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
}

// borrowed from https://gist.github.com/niyazpk/f8ac616f181f6042d1e0
function updateUrlParameter (uri, key, value) {
// remove the hash part before operating on the uri
var
    i = uri.indexOf('#'),
    hash = i === -1 ? '' : uri.substr(i)
    ;

uri = i === -1 ? uri : uri.substr(0, i);

var
    re = new RegExp("([?&])" + key + "=.*?(&|$)", "i"),
    separator = uri.indexOf('?') !== -1 ? "&" : "?"
    ;

if (!value) {
    // remove key-value pair if value is empty
    uri = uri.replace(new RegExp("([?&]?)" + key + "=[^&]*", "i"), '');

    if (uri.slice(-1) === '?') {
        uri = uri.slice(0, -1);
    }
    // replace first occurrence of & by ? if no ? is present

    if (uri.indexOf('?') === -1) {
        uri = uri.replace(/&/, '?');
    }

} else if (uri.match(re)) {
    uri = uri.replace(re, '$1' + key + "=" + value + '$2');
} else {
    uri = uri + separator + key + "=" + value;
}
return uri + hash;
}

var
lang = getQueryStringValue('lang') || 'en',
stretching = getQueryStringValue('stretching') || 'auto',
languageSelector = document.querySelector('select[name=lang]'),
stretchingSelector = document.querySelector('select[name=stretching]'),
sourcesSelector = document.querySelectorAll('select[name=sources]'),
sourcesTotal = sourcesSelector.length
;

languageSelector.value = lang;
languageSelector.addEventListener('change', function () {
window.location.href = updateUrlParameter(window.location.href, 'lang', languageSelector.value);
});
stretchingSelector.value = stretching;
stretchingSelector.addEventListener('change', function () {
window.location.href = updateUrlParameter(window.location.href, 'stretching', stretchingSelector.value);
});

for (var i = 0; i < sourcesTotal; i++) {
sourcesSelector[i].addEventListener('change', function () {

    var
        media = this.closest('.players').querySelector('.mejs__container').id,
        player = mejs.players[media]
    ;

    player.setSrc(this.value.replace('&amp;', '&'));
    player.load();
    if (!mejs.Features.isiOS && !mejs.Features.isAndroid) {
        player.play();
    }

    var renderer = document.getElementById(player.media.id + '-rendername');
    renderer.querySelector('.src').innerHTML = '<a href="' + this.value + '" target="_blank">' + this.value + '</a>';
    renderer.querySelector('.renderer').innerHTML = player.media.rendererName;
    renderer.querySelector('.error').innerHTML = '';

});

// These media types cannot play at all on iOS, so disabling them
if (mejs.Features.isiOS) {
    sourcesSelector[i].querySelector('option[value^="rtmp"]').disabled = true;
    if (sourcesSelector[i].querySelector('option[value$="webm"]')) {
        sourcesSelector[i].querySelector('option[value$="webm"]').disabled = true;
    }
    if (sourcesSelector[i].querySelector('option[value$=".mpd"]')) {
        sourcesSelector[i].querySelector('option[value$=".mpd"]').disabled = true;
    }
    if (sourcesSelector[i].querySelector('option[value$=".ogg"]')) {
        sourcesSelector[i].querySelector('option[value$=".ogg"]').disabled = true;
    }
    if (sourcesSelector[i].querySelector('option[value$=".flv"]')) {
        sourcesSelector[i].querySelector('option[value*=".flv"]').disabled = true;
    }
}
}

document.addEventListener('DOMContentLoaded', function () {

mejs.i18n.language(lang);

var mediaElements = document.querySelectorAll('video, audio'), i, total = mediaElements.length;

for (i = 0; i < total; i++) {
    new MediaElementPlayer(mediaElements[i], {
        stretching: stretching,
        pluginPath: '../build/',
        success: function (media) {
            var renderer = document.getElementById(media.id + '-rendername');

            media.addEventListener('loadedmetadata', function () {
                var src = media.originalNode.getAttribute('src').replace('&amp;', '&');
                if (src !== null && src !== undefined) {
                    renderer.querySelector('.src').innerHTML = '<a href="' + src + '" target="_blank">' + src + '</a>';
                    renderer.querySelector('.renderer').innerHTML = media.rendererName;
                    renderer.querySelector('.error').innerHTML = '';
                }
            });

            media.addEventListener('error', function (e) {
                renderer.querySelector('.error').innerHTML = '<strong>Error</strong>: ' + e.message;
            });
        }
    });
}
});
</script>

</body>
</html>
